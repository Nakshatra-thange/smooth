
generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}
enum MessageRole {
  user
  assistant
}

enum TransactionStatus {
  PENDING
  APPROVED
  SIGNED
  SUBMITTED
  CONFIRMED
  FAILED
  EXPIRED
  CANCELLED
}

enum TransactionType {
  TRANSFER_SOL
  TRANSFER_TOKEN
  SWAP
  STAKE
  NFT_TRANSFER
}

// ===============================
// MODELS
// ===============================

model User {
  id            String         @id @default(cuid())
  walletAddress String         @unique
  preferences   Json?
  createdAt     DateTime       @default(now())
  lastSeenAt    DateTime       @updatedAt

  conversations Conversation[]
  transactions  Transaction[]

  @@index([walletAddress])
}

model Conversation {
  id        String     @id @default(cuid())
  userId    String
  title     String?
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages    Message[]
  transactions Transaction[]

  @@index([userId])
  @@index([userId, isActive])
  @@index([updatedAt])
}

model Message {
  id             String      @id @default(cuid())
  conversationId String
  role           MessageRole
  content        String      @db.Text
  metadata       Json?
  createdAt      DateTime    @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([conversationId, createdAt])
}

model Transaction {
  id             String            @id @default(cuid())
  userId         String
  conversationId String?

  status TransactionStatus
  type   TransactionType

  fromAddress String
  toAddress   String
  amount      BigInt
  memo        String?

  signature  String?   @unique
  blockTime  DateTime?
  fee        BigInt?
  slot       BigInt?

  unsignedTx   String?   @db.Text
  errorMessage String?

  createdAt   DateTime  @default(now())
  expiresAt   DateTime?
  confirmedAt DateTime?

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversation Conversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([status])
  @@index([signature])
  @@index([userId, status])
  @@index([userId, createdAt])
}
